(()=>{"use strict";(()=>{const e=(e,t,n)=>()=>{200===e.status?t(e.response):n(`Статус ответа: ${e.status} ${e.statusText}`)},t=()=>{const e=new XMLHttpRequest;return e.responseType="json",e.timeout=1e4,e};window.backend={load:(n,o)=>{const r=t();r.addEventListener("load",e(r,n,o)),r.addEventListener("error",(e=>()=>e("Произошла ошибка соединения"))(o)),r.addEventListener("timeout",((e,t)=>()=>t(`Запрос не успел выполниться за ${e.timeout}мс`))(r,o)),r.open("GET","https://21.javascript.pages.academy/kekstagram/data"),r.send()},save:(n,o,r)=>{const s=t();s.addEventListener("load",e(s,o,r)),s.open("POST","https://21.javascript.pages.academy/kekstagram"),s.send(n)}}})(),(()=>{const e="img-filters__button--active",t=document.querySelector(".pictures"),n=document.querySelector(".img-filters__form"),o=new Map([["filter-random",e=>s(e).splice(10)],["filter-discussed",e=>e.sort(((e,t)=>t.comments.length-e.comments.length))],["filter-default",()=>{}]]),r={onFilterChange:()=>{}},s=e=>{for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1)),o=e[t];e[t]=e[n],e[n]=o}return e};n.addEventListener("click",(t=>{(t=>{const o=n.querySelector("."+e);o&&o.classList.remove(e),t.target.classList.add(e)})(t),r.onFilterChange(t)})),window.filter={filterChangeHandler:e=>{r.onFilterChange=e},applyFilter:(e,n)=>{let r=Array.from(n);o.get(e.target.id)(r),Array.from(t.children).forEach((e=>{e.classList.contains("picture")&&e.remove()})),window.data.renderPhotos(r)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>e(...n)),500)}},(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content,n=document.querySelector(".img-filters");let o=[];const r=n=>{const o=document.createDocumentFragment();var r;n.forEach((r=o,e=>r.appendChild((({url:e,likes:n,comments:o})=>{const r=t.cloneNode(!0),s=e;return r.querySelector(".picture__img").src=e,r.querySelector(".picture__likes").textContent=n,r.querySelector(".picture__comments").textContent=o.length,r.querySelector(".picture").dataset.path=s,r})(e)))),e.appendChild(o)};window.filter.filterChangeHandler(window.debounce((e=>{(e=>{window.filter.applyFilter(e,o)})(e)}))),window.backend.load((e=>{o=e,r(o),n.classList.remove("img-filters--inactive")}),(e=>{var t=document.createElement("div");t.style.position="absolute",t.style.top="25px",t.style.left="245px",t.style.right="245px",t.style.zIndex=1,t.style.textAlign="center",t.style.backgroundColor="tomato",t.style.fontSize="15px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),window.data={getPhoto:e=>o.find((t=>t.url.includes(e))),renderPhotos:r}})(),window.utils={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t(e))},getRandomNumberMaxToMin:(e,t=0)=>Math.floor(Math.random()*(e-t+1)+t)},(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social__comment").cloneNode(!0),n=e.querySelector(".social__comment-count"),o=e.querySelector(".comments-loader");let r=[],s=[],l=1;const c=t=>{const n=e.querySelector(".social__comments"),o=document.createDocumentFragment();t.forEach((e=>m(o,e))),n.innerHTML="",n.appendChild(o)},i=e=>e.slice(0,5*l),a=e=>{const[t]=n.innerHTML.split(" ");n.innerHTML=n.innerHTML.replace(t,e)},d=()=>{l++,s=i(r),s.length===r.length&&u(),c(s),a(s.length)},u=()=>{l=1,o.classList.add("hidden"),o.removeEventListener("click",d)},m=(e,{avatar:n,name:o,message:r})=>{const s=t.cloneNode(!0);s.querySelector("img").src=n,s.querySelector("img").alt=o,s.querySelector(".social__text").textContent=r,e.appendChild(s)};window.comments={rendenderPhotoAndComments:({url:t,description:l,likes:m,comments:v})=>{r=v,s=i(r),a(s.length),e.querySelector(".big-picture__img").querySelector("img").src=t,e.querySelector(".likes-count").textContent=m,e.querySelector(".comments-count").textContent=v.length,c(s),e.querySelector(".social__caption").textContent=l,(e=>{e.length>5?(u(),n.classList.remove("hidden"),o.classList.remove("hidden"),o.addEventListener("click",d)):(n.classList.add("hidden"),o.classList.add("hidden"))})(r)}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".cancel"),n=()=>{document.body.classList.toggle("modal-open"),e.classList.toggle("hidden"),document.removeEventListener("keydown",o),t.removeEventListener("click",r)},o=e=>window.utils.isEscEvent(e,n),r=n,s=n=>{const s=n.target.dataset.path?n.target.dataset.path:n.target.parentElement.dataset.path;if(s){const n=window.data.getPhoto(s);window.comments.rendenderPhotoAndComments(n),document.activeElement.blur(),document.body.classList.toggle("modal-open"),e.classList.toggle("hidden"),document.addEventListener("keydown",o),t.addEventListener("click",r)}},l=s;window.preview={onPreviewClick:l,onPreviewEnterPress:e=>window.utils.isEnterEvent(e,s)}})(),(()=>{const e=document.querySelector(".pictures");e.addEventListener("click",window.preview.onPreviewClick),e.addEventListener("keydown",window.preview.onPreviewEnterPress)})(),(()=>{const e=100,t=document.querySelector(".img-upload__form"),n=t.querySelector(".img-upload__overlay"),o=n.querySelector(".img-upload__preview"),r=o.querySelector("img"),s=t.querySelector(".scale__control--value"),l=t.querySelector(".scale__control--smaller"),c=t.querySelector(".scale__control--bigger"),i=n.querySelector(".effect-level"),a=()=>{s.value="100%",o.style.transform="scale(1)"},d=()=>parseInt(s.value.replace("%",""),10);l.addEventListener("click",(()=>{const t=(n=d())-25<25?25:n-25;var n;s.value=t+"%",o.style.transform=`scale(${t/e})`})),c.addEventListener("click",(()=>{const t=(n=d())+25>e?e:n+25;var n;s.value=t+"%",o.style.transform=`scale(${t/e})`})),window.effect={onEffectChange:e=>{e.target&&e.target.matches('input[type="radio"]')&&(0!==r.classList.length&&r.classList.remove(Array.from(r.classList)),r.classList.add("effects__preview--"+e.target.value),r.style="",window.slider.renderDefaultSlider(),r.classList.contains("effects__preview--none")?i.classList.add("hidden"):i.classList.remove("hidden"))},setDefaultEffect:()=>{r.style="",r.className="",r.classList.add("effects__preview--none"),a()},resetScale:a}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".img-upload__preview").querySelector("img"),n=e.querySelector(".effect-level"),o=n.querySelector(".effect-level__value"),r=n.querySelector(".effect-level__line"),s=r.querySelector(".effect-level__pin"),l=r.querySelector(".effect-level__depth"),c={x:0,y:0},i=new Map([["effects__preview--chrome",e=>`filter: grayscale(${e/100})`],["effects__preview--sepia",e=>`filter: sepia(${e/100})`],["effects__preview--marvin",e=>`filter: invert(${e}%)`],["effects__preview--phobos",e=>{const t=e/33;return`filter: blur(${t>3?Math.round(t):t}px)`}],["effects__preview--heat",e=>{let t=e/33;return t<1?t=1:t>3&&(t=Math.round(3)),`filter: brightness(${t})`}],["effects__preview--none",()=>""]]),a=e=>{e.preventDefault();const t={x:c.x-e.clientX,y:c.y-e.clientY};c.x=e.clientX,c.y=e.clientY,d(t)},d=e=>{const t=getComputedStyle(r).width.replace("px",""),n=s.offsetLeft-e.x;let c=0;c=n>=t?t:n<=0?0:n;const i=100*c/t;s.style.left=i+"%",l.style.width=Math.round(i)+"%",o.value=Math.round(i),u(o.value)},u=e=>{const[n]=Array.from(t.classList);t.style=(e=>i.get(e))(n)(e)},m=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",m)};s.addEventListener("mousedown",(e=>{e.preventDefault(),c.x=e.clientX,c.y=e.clientY,document.addEventListener("mousemove",a),document.addEventListener("mouseup",m)})),window.slider={renderDefaultSlider:()=>{s.style.left="100%",l.style.width="100%",o.value="100"}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector(".img-upload__form"),n=t.querySelector(".img-upload__overlay"),o=document.querySelector("#success").content.querySelector(".success"),r=document.querySelector("#error").content.querySelector(".error");let s,l;const c=t=>{s=t.cloneNode(!0),l=s.querySelector("button"),e.appendChild(s),l.addEventListener("click",a),s.addEventListener("click",d),document.addEventListener("keydown",u)},i=()=>{e.removeChild(s),l.removeEventListener("click",a),s.removeEventListener("click",d),document.removeEventListener("keydown",u)},a=i,d=e=>{e.target.className===s.className&&i()},u=e=>{window.utils.isEscEvent(e,i)},m=()=>{window.effect.setDefaultEffect(),t.reset()};window.handlers={successHandler:()=>{n.classList.add("hidden"),m(),c(o)},errorHandler:()=>{n.classList.add("hidden"),m(),c(r)}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".img-upload__overlay"),n=e.querySelector("#upload-file"),o=e.querySelector("#upload-cancel"),r=t.querySelector(".effect-level"),s=t.querySelector(".text__hashtags"),l=t.querySelector(".text__description"),c=e=>{document.activeElement!==s&&document.activeElement!==l&&window.utils.isEscEvent(e,i)},i=()=>{window.effect.setDefaultEffect(),e.reset(),document.body.classList.toggle("modal-open"),t.classList.add("hidden"),document.removeEventListener("keydown",c),o.removeEventListener("click",a)},a=i;n.addEventListener("change",(()=>{window.effect.resetScale(),document.body.classList.toggle("modal-open"),t.classList.remove("hidden"),r.classList.add("hidden"),document.addEventListener("keydown",c),o.addEventListener("click",a)})),e.addEventListener("change",window.effect.onEffectChange),s.addEventListener("input",(()=>{s.value.split(" ").forEach(window.validation.setHashtagValidationMessage)})),e.addEventListener("submit",(t=>{t.preventDefault(),window.backend.save(new FormData(e),window.handlers.successHandler,window.handlers.errorHandler)}))})(),(()=>{const e={MIN_LENGTH:2,MAX_LENGTH:20,MAX_COUNT:5,REGEX:/^#[a-zA-Z0-9]*$/},t=document.querySelector(".img-upload__form").querySelector(".img-upload__overlay").querySelector(".text__hashtags");window.validation={setHashtagValidationMessage:(n,o,r)=>{const[s]=n;s?"#"!==s?t.setCustomValidity("Хэштег должен начинаться с #"):n.length<e.MIN_LENGTH?t.setCustomValidity((t=>`Ещё минимум ${e.MIN_LENGTH-t.length} симв.`)(n)):n.length>e.MAX_LENGTH?t.setCustomValidity((t=>`Удалите лишние ${t.length-e.MAX_LENGTH} симв.`)(n)):e.REGEX.test(n)?o>=e.MAX_COUNT?t.setCustomValidity(`Можно ввести только ${e.MAX_COUNT} хэштегов`):r.some(((e,t)=>e.toLowerCase()===n.toLowerCase()&&e[t]!==n[o]))?t.setCustomValidity((e=>`Вы ввели ${e} хэштег более одного раза`)(n)):t.setCustomValidity(""):t.setCustomValidity("Хэштег не должен содержать спецсимволы - #, @, $ и т. п."):t.setCustomValidity(""),t.reportValidity()?t.style.outlineColor="black":t.style.outlineColor="tomato"}}})()})();
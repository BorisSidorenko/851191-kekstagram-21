(()=>{"use strict";(()=>{const e=(e,t,n)=>()=>{200===e.status?t(e.response):n(`Статус ответа: ${e.status} ${e.statusText}`)},t=()=>{const e=new XMLHttpRequest;return e.responseType="json",e.timeout=1e4,e};window.backend={load:(n,r)=>{const o=t();o.addEventListener("load",e(o,n,r)),o.addEventListener("error",(e=>()=>e("Произошла ошибка соединения"))(r)),o.addEventListener("timeout",((e,t)=>()=>t(`Запрос не успел выполниться за ${e.timeout}мс`))(o,r)),o.open("GET","https://21.javascript.pages.academy/kekstagram/data"),o.send()},save:(n,r,o)=>{const s=t();s.addEventListener("load",e(s,r,o)),s.open("POST","https://21.javascript.pages.academy/kekstagram"),s.send(n)}}})(),(()=>{const e=document.querySelector("#upload-file"),t=document.querySelector(".img-upload__preview").querySelector("img"),n=e.accept.split(","),r=t.src,o=e=>t.src=e.target.result;e.addEventListener("change",(()=>{const[s]=e.files;if(n.some((e=>e.trim()===s.type))){const e=new FileReader;e.addEventListener("load",o),e.readAsDataURL(s)}else t.src=r}))})(),(()=>{const e="img-filters__button--active",t=document.querySelector(".pictures"),n=document.querySelector(".img-filters__form"),r=new Map([["filter-random",e=>s(e).splice(10)],["filter-discussed",e=>e.sort(((e,t)=>t.comments.length-e.comments.length))],["filter-default",()=>{}]]),o={onFilterChange:()=>{}},s=e=>{for(let t=e.length-1;t>0;t--){let n=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[n],e[n]=r}return e};n.addEventListener("click",(t=>{(t=>{const r=n.querySelector("."+e);r&&r.classList.remove(e),t.target.classList.add(e)})(t),o.onFilterChange(t)})),window.filter={filterChangeHandler:e=>{o.onFilterChange=e},applyFilter:(e,n)=>{let o=Array.from(n);r.get(e.target.id)(o),Array.from(t.children).forEach((e=>{e.classList.contains("picture")&&e.remove()})),window.data.renderPhotos(o)}}})(),window.debounce=e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>e(...n)),500)}},(()=>{const e=document.querySelector(".pictures"),t=document.querySelector("#picture").content,n=document.querySelector(".img-filters");let r=[];const o=n=>{const r=document.createDocumentFragment();var o;n.forEach((o=r,e=>o.appendChild((({url:e,likes:n,comments:r})=>{const o=t.cloneNode(!0),s=e;return o.querySelector(".picture__img").src=e,o.querySelector(".picture__likes").textContent=n,o.querySelector(".picture__comments").textContent=r.length,o.querySelector(".picture").dataset.path=s,o})(e)))),e.appendChild(r)};window.filter.filterChangeHandler(window.debounce((e=>{(e=>{window.filter.applyFilter(e,r)})(e)}))),window.backend.load((e=>{r=e,o(r),n.classList.remove("img-filters--inactive")}),(e=>{const t=document.createElement("div");t.style.position="absolute",t.style.top="25px",t.style.left="245px",t.style.right="245px",t.style.zIndex=1,t.style.textAlign="center",t.style.backgroundColor="tomato",t.style.fontSize="15px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),window.data={getPhoto:e=>r.find((t=>t.url.includes(e))),renderPhotos:o}})(),window.utils={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t(e))}},(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social__comment").cloneNode(!0),n=e.querySelector(".social__comment-count"),r=e.querySelector(".comments-loader");let o=[],s=[],l=1;const c=t=>{const n=e.querySelector(".social__comments"),r=document.createDocumentFragment();t.forEach((e=>m(r,e))),n.innerHTML="",n.appendChild(r)},i=e=>e.slice(0,5*l),a=e=>{const[t]=n.innerHTML.split(" ");n.innerHTML=n.innerHTML.replace(t,e)},d=()=>{l++,s=i(o),s.length===o.length&&u(),c(s),a(s.length)},u=()=>{l=1,r.classList.add("hidden"),r.removeEventListener("click",d)},m=(e,{avatar:n,name:r,message:o})=>{const s=t.cloneNode(!0);s.querySelector("img").src=n,s.querySelector("img").alt=r,s.querySelector(".social__text").textContent=o,e.appendChild(s)};window.comments={rendenderPhotoAndComments:({url:t,description:l,likes:m,comments:y})=>{o=y,s=i(o),a(s.length),e.querySelector(".big-picture__img").querySelector("img").src=t,e.querySelector(".likes-count").textContent=m,e.querySelector(".comments-count").textContent=y.length,c(s),e.querySelector(".social__caption").textContent=l,(e=>{e.length>5?(u(),n.classList.remove("hidden"),r.classList.remove("hidden"),r.addEventListener("click",d)):(n.classList.add("hidden"),r.classList.add("hidden"))})(o)}}})(),(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".cancel"),n=()=>{document.body.classList.toggle("modal-open"),e.classList.toggle("hidden"),document.removeEventListener("keydown",r),t.removeEventListener("click",o)},r=e=>window.utils.isEscEvent(e,n),o=n,s=n=>{const s=n.target.dataset.path?n.target.dataset.path:n.target.parentElement.dataset.path;if(s){const n=window.data.getPhoto(s);window.comments.rendenderPhotoAndComments(n),document.activeElement.blur(),document.body.classList.toggle("modal-open"),e.classList.toggle("hidden"),document.addEventListener("keydown",r),t.addEventListener("click",o)}},l=s;window.preview={onPreviewClick:l,onPreviewEnterPress:e=>window.utils.isEnterEvent(e,s)}})(),(()=>{const e=document.querySelector(".pictures");e.addEventListener("click",window.preview.onPreviewClick),e.addEventListener("keydown",window.preview.onPreviewEnterPress)})(),(()=>{const e=100,t=document.querySelector(".img-upload__form"),n=t.querySelector(".img-upload__overlay"),r=n.querySelector(".img-upload__preview"),o=r.querySelector("img"),s=t.querySelector(".scale__control--value"),l=t.querySelector(".scale__control--smaller"),c=t.querySelector(".scale__control--bigger"),i=n.querySelector(".effect-level"),a=()=>{s.value="100%",r.style.transform="scale(1)"},d=()=>parseInt(s.value.replace("%",""),10);l.addEventListener("click",(()=>{const t=(n=d())-25<25?25:n-25;var n;s.value=t+"%",r.style.transform=`scale(${t/e})`})),c.addEventListener("click",(()=>{const t=(n=d())+25>e?e:n+25;var n;s.value=t+"%",r.style.transform=`scale(${t/e})`})),window.effect={onEffectChange:e=>{e.target&&e.target.matches('input[type="radio"]')&&(0!==o.classList.length&&o.classList.remove(Array.from(o.classList)),o.classList.add("effects__preview--"+e.target.value),o.style="",window.slider.renderDefaultSlider(),o.classList.contains("effects__preview--none")?i.classList.add("hidden"):i.classList.remove("hidden"))},setDefaultEffect:()=>{o.style="",o.className="",o.classList.add("effects__preview--none"),a()},resetScale:a}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".img-upload__preview").querySelector("img"),n=e.querySelector(".effect-level"),r=n.querySelector(".effect-level__value"),o=n.querySelector(".effect-level__line"),s=o.querySelector(".effect-level__pin"),l=o.querySelector(".effect-level__depth"),c={x:0,y:0},i=new Map([["effects__preview--chrome",e=>`filter: grayscale(${e/100})`],["effects__preview--sepia",e=>`filter: sepia(${e/100})`],["effects__preview--marvin",e=>`filter: invert(${e}%)`],["effects__preview--phobos",e=>{const t=e/33;return`filter: blur(${t>3?Math.round(t):t}px)`}],["effects__preview--heat",e=>{let t=e/33;return t<1?t=1:t>3&&(t=Math.round(3)),`filter: brightness(${t})`}],["effects__preview--none",()=>""]]),a=e=>{e.preventDefault();const t={x:c.x-e.clientX,y:c.y-e.clientY};c.x=e.clientX,c.y=e.clientY,d(t)},d=e=>{const t=getComputedStyle(o).width.replace("px",""),n=s.offsetLeft-e.x;let c=0;c=n>=t?t:n<=0?0:n;const i=100*c/t;s.style.left=i+"%",l.style.width=Math.round(i)+"%",r.value=Math.round(i),u(r.value)},u=e=>{const[n]=Array.from(t.classList);t.style=(e=>i.get(e))(n)(e)},m=e=>{e.preventDefault(),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",m)};s.addEventListener("mousedown",(e=>{e.preventDefault(),c.x=e.clientX,c.y=e.clientY,document.addEventListener("mousemove",a),document.addEventListener("mouseup",m)})),window.slider={renderDefaultSlider:()=>{s.style.left="100%",l.style.width="100%",r.value="100"}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector(".img-upload__form"),n=t.querySelector(".img-upload__preview").querySelector("img"),r=t.querySelector(".img-upload__overlay"),o=document.querySelector("#success").content.querySelector(".success"),s=document.querySelector("#error").content.querySelector(".error");let l,c;const i=t=>{l=t.cloneNode(!0),c=l.querySelector("button"),e.appendChild(l),c.addEventListener("click",d),l.addEventListener("click",u),document.addEventListener("keydown",m)},a=()=>{e.removeChild(l),c.removeEventListener("click",d),l.removeEventListener("click",u),document.removeEventListener("keydown",m)},d=a,u=e=>{e.target.className===l.className&&a()},m=e=>{window.utils.isEscEvent(e,a)},y=()=>{n.src="",window.effect.setDefaultEffect(),t.reset()};window.handlers={successHandler:()=>{r.classList.add("hidden"),y(),i(o)},errorHandler:()=>{r.classList.add("hidden"),y(),i(s)}}})(),(()=>{const e=document.querySelector(".img-upload__form"),t=e.querySelector(".img-upload__overlay"),n=e.querySelector("#upload-file"),r=e.querySelector("#upload-cancel"),o=t.querySelector(".effect-level"),s=t.querySelector(".text__hashtags"),l=t.querySelector(".text__description"),c=e=>{document.activeElement!==s&&document.activeElement!==l&&window.utils.isEscEvent(e,i)},i=()=>{window.effect.setDefaultEffect(),e.reset(),document.body.classList.toggle("modal-open"),t.classList.add("hidden"),document.removeEventListener("keydown",c),r.removeEventListener("click",a)},a=i;n.addEventListener("change",(()=>{window.effect.resetScale(),document.body.classList.toggle("modal-open"),t.classList.remove("hidden"),o.classList.add("hidden"),document.addEventListener("keydown",c),r.addEventListener("click",a)})),e.addEventListener("change",window.effect.onEffectChange),s.addEventListener("input",(()=>{s.value.trim().split(" ").forEach(window.validation.setHashtagValidationMessage)})),e.addEventListener("submit",(t=>{t.preventDefault(),window.backend.save(new FormData(e),window.handlers.successHandler,window.handlers.errorHandler)}))})(),(()=>{const e={MIN_LENGTH:2,MAX_LENGTH:20,MAX_COUNT:5,REGEX:/^#[а-яА-яa-zA-Z0-9]*$/},t="Хэштег должен начинаться с #",n="Хэштег не должен содержать спецсимволы - #, @, $ и т. п.",r=document.querySelector(".img-upload__form").querySelector(".img-upload__overlay").querySelector(".text__hashtags");window.validation={setHashtagValidationMessage:(o,s,l)=>{const[c]=o;c?"#"!==c?r.setCustomValidity(t):o.length<e.MIN_LENGTH?r.setCustomValidity((t=>`Ещё минимум ${e.MIN_LENGTH-t.length} симв.`)(o)):o.length>e.MAX_LENGTH?r.setCustomValidity((t=>`Удалите лишние ${t.length-e.MAX_LENGTH} симв.`)(o)):e.REGEX.test(o)?s>=e.MAX_COUNT?r.setCustomValidity(`Можно ввести только ${e.MAX_COUNT} хэштегов`):l.some(((e,t)=>e.toLowerCase()===o.toLowerCase()&&e[t]!==o[s]))?r.setCustomValidity((e=>`Вы ввели ${e} хэштег более одного раза`)(o)):(e=>{const t=e.map((e=>e.toLowerCase()));return new Set(t).size!==e.length})(l)?r.setCustomValidity("Вы ввели некоторые хэштеги более одного раза"):r.setCustomValidity(""):r.setCustomValidity(n):r.setCustomValidity(""),r.reportValidity()?r.style.outlineColor="black":r.style.outlineColor="tomato"}}})()})();